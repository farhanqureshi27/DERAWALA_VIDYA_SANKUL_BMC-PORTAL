<!DOCTYPE html>
<html>

<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>JSFiddle ckpg5vhe</title>

  <style>
    
  </style>

  
</head>
<body>
  <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVS Professional Master Portal v3.0 - Firebase</title>
    <style>
        :root {
            --main: #1a237e;
            --main-light: #3949ab;
            --neg: #b71c1c;
            --neg-light: #ffebee;
            --pos: #1b5e20;
            --pos-light: #e8f5e9;
            --bg: #f5f7fa;
            --gold: #d4af37;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, var(--main) 0%, var(--main-light) 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .header h1 {
            margin: 0 0 5px 0;
            font-size: 1.8em;
        }
        
        .header small {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        .sync-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }
        
        .sync-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }
        
        .sync-dot.offline {
            background: #f44336;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Login Section */
        #login-section {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
        }
        
        #login-section h2 {
            color: var(--main);
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo {
            text-align: center;
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        /* Menu Cards */
        .menu-container {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .menu-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--main);
        }
        
        .menu-card span {
            font-size: 1.1em;
            font-weight: 500;
        }
        
        .menu-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        /* Container Panels */
        .container {
            padding: 20px;
            display: none;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
            margin-top: 20px;
        }
        
        .panel h2, .panel h3 {
            margin-top: 0;
            border-bottom: 3px solid var(--main);
            padding-bottom: 10px;
        }
        
        /* Staff Name Input */
        .staff-input-container {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid var(--main);
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95em;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--main);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Buttons */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-main { background: var(--main); }
        .btn-main:hover { background: var(--main-light); }
        .btn-neg { background: var(--neg); }
        .btn-neg:hover { background: #c62828; }
        .btn-pos { background: var(--pos); }
        .btn-pos:hover { background: #2e7d32; }
        .btn-danger { background: #d32f2f; }
        .btn-danger:hover { background: #f44336; }
        
        .btn-back {
            width: auto;
            padding: 10px 20px;
            margin-bottom: 15px;
            background: #757575;
        }
        
        .btn-back:hover {
            background: #616161;
        }
        
        /* Report Grid */
        .report-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 25px;
        }
        
        .neg-col, .pos-col {
            padding: 20px;
            border-radius: 10px;
            min-height: 200px;
        }
        
        .neg-col {
            background: var(--neg-light);
            border: 2px solid var(--neg);
        }
        
        .pos-col {
            background: var(--pos-light);
            border: 2px solid var(--pos);
        }
        
        .neg-col h4 {
            color: var(--neg);
            margin-top: 0;
        }
        
        .pos-col h4 {
            color: var(--pos);
            margin-top: 0;
        }
        
        .log-entry {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid;
            font-size: 0.9em;
        }
        
        .neg-col .log-entry {
            border-left-color: var(--neg);
        }
        
        .pos-col .log-entry {
            border-left-color: var(--pos);
        }
        
        .total-row {
            font-weight: bold;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 3px solid #333;
            font-size: 1.1em;
        }
        
        /* Alert Messages */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .alert-success {
            background: var(--pos-light);
            color: var(--pos);
            border: 2px solid var(--pos);
        }
        
        .alert-error {
            background: var(--neg-light);
            color: var(--neg);
            border: 2px solid var(--neg);
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--main) 0%, var(--main-light) 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            margin: 0;
            font-size: 2em;
        }
        
        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        
        .hidden {
            display: none !important;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .badge-admin {
            background: #ff9800;
            color: white;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--main);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .menu-container {
                grid-template-columns: 1fr;
            }
            
            .report-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<!-- Sync Indicator -->
<div class="sync-indicator">
    <div class="sync-dot" id="syncDot"></div>
    <span id="syncText">Connected</span>
</div>

<!-- Login Section -->
<div id="login-section">
    <div class="login-logo">üè´</div>
    <h2 id="loginTitle">DVS MASTER LOGIN</h2>
    <div class="form-group">
        <label>User ID</label>
        <input type="text" id="uID" placeholder="Enter your User ID" autocomplete="username">
    </div>
    <div class="form-group">
        <label>Password</label>
        <input type="password" id="uPass" placeholder="Enter your Password" autocomplete="current-password">
    </div>
    <button class="btn btn-main" onclick="doLogin()">Login to Portal</button>
</div>

<!-- Portal Section -->
<div id="portal-section" style="display:none;">
    <div class="header" id="mainHeader">
        <h1 id="headerTitle">üè´ DERAWALA VIDYA SANKUL</h1>
        <small id="userDisplay"></small>
    </div>

    <!-- Main Menu -->
    <div id="main-menu" class="menu-container">
        <div class="menu-card admin-only" onclick="showPanel('tab-t-reg')" style="display:none;">
            <div class="icon">üë®‚Äçüè´</div>
            <span>Teacher Registration</span>
        </div>
        <div class="menu-card admin-only" onclick="showPanel('tab-s-reg')" style="display:none;">
            <div class="icon">üéì</div>
            <span>Student Registration</span>
        </div>
        <div class="menu-card" onclick="showPanel('tab-neg')">
            <div class="icon">‚ö†Ô∏è</div>
            <span>Negative BMC</span>
        </div>
        <div class="menu-card" onclick="showPanel('tab-pos')">
            <div class="icon">üèÜ</div>
            <span>Positive BMC</span>
        </div>
        <div class="menu-card admin-only" onclick="showPanel('tab-ana')" style="display:none;">
            <div class="icon">üìä</div>
            <span>Analytics & Reports</span>
        </div>
        <div class="menu-card admin-only" onclick="showPanel('tab-manage')" style="display:none;">
            <div class="icon">‚öôÔ∏è</div>
            <span>Manage Records</span>
        </div>
        <div class="menu-card admin-only" onclick="showPanel('tab-config')" style="display:none;">
            <div class="icon">üîß</div>
            <span>System Configuration<span class="badge badge-admin">ADMIN</span></span>
        </div>
        <div class="menu-card" onclick="showPanel('tab-security')">
            <div class="icon">üîê</div>
            <span>Security Settings</span>
        </div>
        <div class="menu-card" onclick="doLogout()" style="background:#fff0f0;">
            <div class="icon" style="color:red;">üö™</div>
            <span style="color:red;">Logout</span>
        </div>
    </div>

    <!-- Negative BMC Entry -->
    <div id="tab-neg" class="container">
        <button class="btn btn-back" onclick="showMenu()">‚Üê Back to Menu</button>
        <div class="panel" style="border-top: 5px solid var(--neg);">
            <h2 style="color:var(--neg);">‚ö†Ô∏è Negative BMC Entry</h2>
            
            <!-- Staff Name Input -->
            <div class="staff-input-container">
                <label style="margin-bottom: 8px;">üë§ Staff Name (Required)</label>
                <input type="text" id="nStaffName" placeholder="Enter your full name" required>
            </div>
            
            <form id="negForm" onsubmit="event.preventDefault(); saveRecord('Negative');">
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="nDate" required>
                </div>
                <div class="form-group">
                    <label>Class *</label>
                    <select id="nCls" onchange="filterStudents('n')" required>
                        <option value="">-- Select Class --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Student Name *</label>
                    <select id="nStd" required>
                        <option value="">-- Select Student --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Issue Grade *</label>
                    <select id="nGrade" onchange="updateIssues()" required>
                        <option value="">-- Select Grade --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Behavior Issue Type *</label>
                    <select id="nIssue" required>
                        <option value="">-- Select Issue --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Action Taken *</label>
                    <textarea id="nAction" rows="3" placeholder="Describe the action taken..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Additional Remarks</label>
                    <textarea id="nRemarks" rows="3" placeholder="Any additional comments..."></textarea>
                </div>
                <div class="form-group" id="notifyParentGroup">
                    <label>Notify Parent?</label>
                    <select id="nNotify">
                        <option value="YES">YES</option>
                        <option value="NO">NO</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-neg">Submit Negative Record</button>
            </form>
        </div>
    </div>

    <!-- Positive BMC Entry -->
    <div id="tab-pos" class="container">
        <button class="btn btn-back" onclick="showMenu()">‚Üê Back to Menu</button>
        <div class="panel" style="border-top: 5px solid var(--pos);">
            <h2 style="color:var(--pos);">üèÜ Positive BMC Entry</h2>
            
            <!-- Staff Name Input -->
            <div class="staff-input-container">
                <label style="margin-bottom: 8px;">üë§ Staff Name (Required)</label>
                <input type="text" id="pStaffName" placeholder="Enter your full name" required>
            </div>
            
            <form id="posForm" onsubmit="event.preventDefault(); saveRecord('Positive');">
                <div class="form-group">
                    <label>Date *</label>
                    <input type="date" id="pDate" required>
                </div>
                <div class="form-group">
                    <label>Class *</label>
                    <select id="pCls" onchange="filterStudents('p')" required>
                        <option value="">-- Select Class --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Student Name *</label>
                    <select id="pStd" required>
                        <option value="">-- Select Student --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Appreciation Points (1-5) *</label>
                    <input type="number" id="pGrade" min="1" max="5" value="3" required>
                    <small style="color:#666;">1 = Good, 3 = Very Good, 5 = Excellent</small>
                </div>
                <div class="form-group">
                    <label>Appreciation Details *</label>
                    <textarea id="pAppreciate" rows="4" placeholder="Describe the positive behavior or achievement..." required></textarea>
                </div>
                <div class="form-group" id="notifyParentGroupPos">
                    <label>Notify Parent?</label>
                    <select id="pNotify">
                        <option value="YES">YES</option>
                        <option value="NO">NO</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-pos">Submit Positive Record</button>
            </form>
        </div>
    </div>

    <!-- Other panels remain the same but are hidden for brevity -->
    <!-- Teacher Registration -->
    <div id="tab-t-reg" class="container">
        <button class="btn btn-back" onclick="showMenu()">‚Üê Back to Menu</button>
        <div class="panel">
            <h3>üë®‚Äçüè´ Staff Registration</h3>
            <form id="teacherForm" onsubmit="event.preventDefault(); regT();">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="rtName" placeholder="Enter full name" required>
                </div>
                <div class="form-group">
                    <label>Designation *</label>
                    <select id="rtRole" required>
                        <option value="">-- Select Role --</option>
                        <option value="Class Teacher">Class Teacher</option>
                        <option value="Subject Teacher">Subject Teacher</option>
                        <option value="Principal">Principal</option>
                        <option value="Director">Director</option>
                        <option value="H.O.D">H.O.D</option>
                        <option value="Coordinator">Coordinator</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Create Login ID *</label>
                    <input type="text" id="rtID" placeholder="Enter unique login ID" required>
                </div>
                <div class="form-group">
                    <label>Create Password *</label>
                    <input type="text" id="rtPass" placeholder="Enter password (min 6 characters)" required>
                </div>
                <button type="submit" class="btn btn-main">Register Teacher</button>
            </form>
        </div>
    </div>

    <!-- Student Registration -->
    <div id="tab-s-reg" class="container">
        <button class="btn btn-back" onclick="showMenu()">‚Üê Back to Menu</button>
        <div class="panel">
            <h3>üéì Student Enrollment</h3>
            <form id="studentForm" onsubmit="event.preventDefault(); regS();">
                <div class="form-group">
                    <label>Student Full Name *</label>
                    <input type="text" id="rsName" placeholder="Enter student's full name" required>
                </div>
                <div class="form-group">
                    <label>Student Class *</label>
                    <select id="rsCls" required>
                        <option value="">-- Select Class --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Parent/Guardian Name</label>
                    <input type="text" id="rsParent" placeholder="Enter parent/guardian name">
                </div>
                <div class="form-group">
                    <label>Contact Number</label>
                    <input type="tel" id="rsContact" placeholder="Enter contact number">
                </div>
                <button type="submit" class="btn btn-main">Enroll Student</button>
            </form>
        </div>
    </div>

    <!-- Analytics & Reports -->
    <div id="tab-ana" class="container">
        <button class="btn btn-back" onclick="showMenu()">‚Üê Back to Menu</button>
        <div class="panel">
            <h3>üìä Analytics & Master Logs</h3>
            
            <div class="stats-grid" id="overallStats"></div>
            
            <div class="form-group">
                <label>Report Type</label>
                <select id="repScope" onchange="toggleAnalyticsView()">
                    <option value="single">Particular Student</option>
                    <option value="all">All Students</option>
                    <option value="class">By Class</option>
                </select>
            </div>
            
            <div class="form-group" id="searchBox">
                <label>Select Student</label>
                <select id="anaStd" onchange="loadStats()">
                    <option value="">-- Select Student --</option>
                </select>
            </div>
            
            <div class="form-group" id="classBox" style="display:none;">
                <label>Select Class</label>
                <select id="anaCls" onchange="loadStats()">
                    <option value="">-- Select Class --</option>
                </select>
            </div>
            
            <div class="report-grid">
                <div class="neg-col">
                    <h4>‚ùå Negative Records</h4>
                    <div id="negLogs"></div>
                    <div class="total-row">Total Negative: <span id="negTotal">0</span></div>
                </div>
                <div class="pos-col">
                    <h4>‚úÖ Positive Records</h4>
                    <div id="posLogs"></div>
                    <div class="total-row">Total Positive: <span id="posTotal">0</span></div>
                </div>
            </div>
            
            <div class="form-group" style="margin-top:25px;">
                <label>Download Format</label>
                <select id="ext">
                    <option value="pdf">PDF Report</option>
                    <option value="xlsx">Excel Spreadsheet</option>
                    <option value="docx">Word Document</option>
                    <option value="csv">CSV File</option>
                </select>
            </div>
            <button class="btn btn-main" onclick="downloadReport()">üì• Download Report</button>
        </div>
    </div>

    <!-- Security Settings -->
    <div id="tab-security" class="container">
        <button class="btn btn-back" onclick="showMenu()">‚Üê Back to Menu</button>
        <div class="panel">
            <h3>üîê Security Settings</h3>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>Current User:</strong> <span id="securityUserName"></span><br>
                <strong>Role:</strong> <span id="securityUserRole"></span><br>
                <strong>User ID:</strong> <span id="securityUserID"></span>
            </div>
            
            <form id="securityForm" onsubmit="event.preventDefault(); changePassword();">
                <div class="form-group">
                    <label>New Password *</label>
                    <input type="password" id="newPassword" placeholder="Enter new password (min 6 characters)" required>
                </div>
                <div class="form-group">
                    <label>Confirm New Password *</label>
                    <input type="password" id="confirmPassword" placeholder="Re-enter new password" required>
                </div>
                <button type="submit" class="btn btn-main">Update Password</button>
            </form>
        </div>
    </div>

    <!-- System Configuration -->
    <div id="tab-config" class="container">
        <button class="btn btn-back" onclick="showMenu()">‚Üê Back to Menu</button>
        <div class="panel">
            <h2>üîß System Configuration <span class="badge badge-admin">ADMIN ONLY</span></h2>
            <div class="alert alert-success">
                Firebase integration active. All changes sync in real-time across all devices.
            </div>
        </div>
    </div>

    <!-- Manage Records -->
    <div id="tab-manage" class="container">
        <button class="btn btn-back" onclick="showMenu()">‚Üê Back to Menu</button>
        <div class="panel">
            <h3>‚öôÔ∏è Manage Records</h3>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalTeachers">0</h3>
                    <p>Total Teachers</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalStudents">0</h3>
                    <p>Total Students</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalRecords">0</h3>
                    <p>Total Records</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase Scripts (compat version) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
    // =====================================================
    // FIREBASE CONFIGURATION
    // =====================================================
    // Your Firebase project credentials
    const firebaseConfig = {
        apiKey: "AIzaSyDzwsZlgTHt_BrXx4aZPKp2xrf4_JRHwSQ",
        authDomain: "dvs-school-bmc-portal.firebaseapp.com",
        databaseURL: "https://dvs-school-bmc-portal-default-rtdb.firebaseio.com",
        projectId: "dvs-school-bmc-portal",
        storageBucket: "dvs-school-bmc-portal.firebasestorage.app",
        messagingSenderId: "631672115024",
        appId: "1:631672115024:web:aad4cd58336cad765ca655",
        measurementId: "G-PNZHM5BKWE"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // Enable offline persistence
    database.ref('.info/connected').on('value', (snapshot) => {
        if (snapshot.val() === true) {
            updateSyncStatus(true);
        } else {
            updateSyncStatus(false);
        }
    });

    // =====================================================
    // GLOBAL STATE
    // =====================================================
    let currentUser = null;
    let localCache = {
        config: null,
        teachers: [],
        students: [],
        logs: []
    };

    // =====================================================
    // SYNC STATUS INDICATOR
    // =====================================================
    function updateSyncStatus(isOnline) {
        const dot = document.getElementById('syncDot');
        const text = document.getElementById('syncText');
        
        if (isOnline) {
            dot.classList.remove('offline');
            text.textContent = 'Connected';
        } else {
            dot.classList.add('offline');
            text.textContent = 'Offline';
        }
    }

    // =====================================================
    // FIREBASE DATA LISTENERS (REAL-TIME SYNC)
    // =====================================================
    
    // Listen to configuration changes
    function initConfigListener() {
        database.ref('config').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                localCache.config = data;
                globalRefresh();
            } else {
                // Initialize default config if none exists
                initializeDefaultConfig();
            }
        });
    }

    // Listen to teachers changes
    function initTeachersListener() {
        database.ref('teachers').on('value', (snapshot) => {
            const data = snapshot.val();
            localCache.teachers = data ? Object.values(data) : [];
            updateTeacherStats();
        });
    }

    // Listen to students changes
    function initStudentsListener() {
        database.ref('students').on('value', (snapshot) => {
            const data = snapshot.val();
            localCache.students = data ? Object.values(data) : [];
            updateStudentDropdowns();
            updateStudentStats();
        });
    }

    // Listen to logs changes (THE MAGIC REAL-TIME SYNC!)
    function initLogsListener() {
        database.ref('logs').on('value', (snapshot) => {
            const data = snapshot.val();
            localCache.logs = data ? Object.values(data) : [];
            
            // Update analytics if panel is open
            if (document.getElementById('tab-ana').style.display === 'block') {
                loadStats();
            }
            
            updateRecordStats();
            
            // Show notification for new entries (optional)
            console.log('Data synced:', localCache.logs.length, 'records');
        });
    }

    // =====================================================
    // INITIALIZE DEFAULT CONFIGURATION
    // =====================================================
    function initializeDefaultConfig() {
        const defaultConfig = {
            branding: {
                schoolName: "DERAWALA VIDYA SANKUL",
                motto: "Excellence in Education",
                primaryColor: "#1a237e",
                secondaryColor: "#3949ab"
            },
            classes: [
                "Class 1", "Class 2", "Class 3", "Class 4", "Class 5", "Class 6",
                "Class 7", "Class 8", "Class 9", "Class 10", "Class 11", "Class 12"
            ],
            behaviorIssues: {
                "Grade 1": [
                    {id:"ISS-0091", act:"Notebook incomplete"},
                    {id:"ISS-0092", act:"Homework not done"},
                    {id:"ISS-0081", act:"Talking during lectures"},
                    {id:"ISS-0093", act:"Not bringing required materials"}
                ],
                "Grade 2": [
                    {id:"ISS-0032", act:"Skipping Classes"},
                    {id:"ISS-0033", act:"Disrespecting Teacher"},
                    {id:"ISS-0029", act:"Mobile Phone Use"},
                    {id:"ISS-0094", act:"Disrupting class activities"}
                ],
                "Grade 3": [
                    {id:"ISS-0030", act:"Cheating in Exam"},
                    {id:"ISS-0034", act:"Bullying Classmate"},
                    {id:"ISS-0095", act:"Vandalism of school property"}
                ],
                "Grade 4": [
                    {id:"ISS-0035", act:"Physical Fight"},
                    {id:"ISS-0047", act:"Tobacco Use"},
                    {id:"ISS-0096", act:"Threatening behavior"}
                ],
                "Grade 5": [
                    {id:"ISS-0039", act:"Weapon in School"},
                    {id:"ISS-0038", act:"Drug/Alcohol Possession"},
                    {id:"ISS-0097", act:"Severe assault"}
                ]
            },
            features: {
                parentNotifications: true,
                studentSelfView: false,
                autoArchive: false
            }
        };

        database.ref('config').set(defaultConfig);
        
        // Initialize default admin
        const defaultAdmin = {
            id: "admin",
            pass: "dvs123",
            name: "Director",
            role: "Admin"
        };
        
        database.ref('admins/admin').set(defaultAdmin);
    }

    // =====================================================
    // LOGIN FUNCTIONS
    // =====================================================
    async function doLogin() {
        try {
            const id = document.getElementById('uID').value.trim();
            const pass = document.getElementById('uPass').value.trim();
            
            if (!id || !pass) {
                alert('Please enter both User ID and Password');
                return;
            }
            
            // Check admins
            const adminSnapshot = await database.ref('admins/' + id).once('value');
            const adminData = adminSnapshot.val();
            
            if (adminData && adminData.pass === pass) {
                currentUser = adminData;
                loginSuccess();
                return;
            }
            
            // Check teachers
            const teachersSnapshot = await database.ref('teachers').once('value');
            const teachers = teachersSnapshot.val();
            
            if (teachers) {
                const teacher = Object.values(teachers).find(t => t.id === id && t.pass === pass);
                if (teacher) {
                    currentUser = teacher;
                    loginSuccess();
                    return;
                }
            }
            
            alert('Invalid User ID or Password\n\nDefault Login:\nUser ID: admin\nPassword: dvs123');
            
        } catch (error) {
            console.error('Login error:', error);
            alert('Login failed. Please check your connection.');
        }
    }

    function loginSuccess() {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('portal-section').style.display = 'block';
        document.getElementById('userDisplay').textContent = 
            `Welcome, ${currentUser.name} (${currentUser.role || 'Teacher'})`;
        
        // Show admin features if user has admin privileges
        if (hasAdminPrivileges()) {
            document.querySelectorAll('.admin-only').forEach(e => e.style.display = 'block');
        }
        
        init();
    }

    function doLogout() {
        if (confirm('Are you sure you want to logout?')) {
            currentUser = null;
            location.reload();
        }
    }

    // =====================================================
    // INITIALIZATION
    // =====================================================
    function init() {
        // Start Firebase listeners
        initConfigListener();
        initTeachersListener();
        initStudentsListener();
        initLogsListener();
        
        // Set today's date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('nDate').value = today;
        document.getElementById('pDate').value = today;
        
        // Pre-fill staff names if user is logged in
        if (currentUser) {
            document.getElementById('nStaffName').value = currentUser.name;
            document.getElementById('pStaffName').value = currentUser.name;
        }
    }

    // =====================================================
    // HELPER FUNCTIONS
    // =====================================================
    function hasAdminPrivileges() {
        if (!currentUser) return false;
        const role = currentUser.role || '';
        return role === 'Admin' || role === 'Principal' || role === 'Director';
    }

    function globalRefresh() {
        if (!localCache.config) return;
        
        applyBranding();
        updateClassDropdowns();
        updateIssueGrades();
        updateFeatureToggles();
    }

    function applyBranding() {
        if (!localCache.config) return;
        
        const branding = localCache.config.branding;
        document.getElementById('headerTitle').innerHTML = `üè´ ${branding.schoolName}`;
        document.getElementById('loginTitle').textContent = `${branding.schoolName} - LOGIN`;
        document.documentElement.style.setProperty('--main', branding.primaryColor);
        document.documentElement.style.setProperty('--main-light', branding.secondaryColor);
    }

    function updateClassDropdowns() {
        if (!localCache.config) return;
        
        const classes = localCache.config.classes;
        const classOptions = '<option value="">-- Select Class --</option>' +
            classes.map(cls => `<option value="${cls}">${cls}</option>`).join('');
        
        ['nCls', 'pCls', 'rsCls', 'anaCls'].forEach(id => {
            const elem = document.getElementById(id);
            if (elem) {
                const currentValue = elem.value;
                elem.innerHTML = classOptions;
                if (classes.includes(currentValue)) {
                    elem.value = currentValue;
                }
            }
        });
    }

    function updateIssueGrades() {
        if (!localCache.config) return;
        
        const grades = Object.keys(localCache.config.behaviorIssues);
        const gradeOptions = '<option value="">-- Select Grade --</option>' +
            grades.map(g => `<option value="${g}">${g} (${getGradeLabel(g)})</option>`).join('');
        
        const gradeSelect = document.getElementById('nGrade');
        if (gradeSelect) {
            const currentValue = gradeSelect.value;
            gradeSelect.innerHTML = gradeOptions;
            if (grades.includes(currentValue)) {
                gradeSelect.value = currentValue;
                updateIssues();
            }
        }
    }

    function getGradeLabel(grade) {
        const labels = {
            "Grade 1": "Minor",
            "Grade 2": "Moderate",
            "Grade 3": "Serious",
            "Grade 4": "Severe",
            "Grade 5": "Critical"
        };
        return labels[grade] || "";
    }

    function updateFeatureToggles() {
        if (!localCache.config) return;
        
        const features = localCache.config.features;
        const notifyGroups = ['notifyParentGroup', 'notifyParentGroupPos'];
        notifyGroups.forEach(id => {
            const elem = document.getElementById(id);
            if (elem) {
                elem.style.display = features.parentNotifications ? 'block' : 'none';
            }
        });
    }

    function updateIssues() {
        if (!localCache.config) return;
        
        const grade = document.getElementById('nGrade').value;
        const list = document.getElementById('nIssue');
        
        if (!grade) {
            list.innerHTML = '<option value="">-- Select Issue --</option>';
            return;
        }
        
        const issues = localCache.config.behaviorIssues[grade] || [];
        list.innerHTML = '<option value="">-- Select Issue --</option>' +
            issues.map(b => `<option value="${b.id}: ${b.act}">${b.id} - ${b.act}</option>`).join('');
    }

    // =====================================================
    // SAVE RECORD TO FIREBASE
    // =====================================================
    async function saveRecord(type) {
        try {
            const pre = type === 'Negative' ? 'n' : 'p';
            const staffName = document.getElementById(pre + 'StaffName').value.trim();
            const date = document.getElementById(pre + 'Date').value;
            const cls = document.getElementById(pre + 'Cls').value;
            const std = document.getElementById(pre + 'Std').value;
            
            // Validation
            if (!staffName) {
                showAlert('Please enter your staff name', 'error');
                return;
            }
            if (!date || !cls || !std) {
                showAlert('Please fill all required fields', 'error');
                return;
            }
            
            // Generate unique ID
            const recordId = 'LOG-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            let logEntry = {
                id: recordId,
                date: date,
                student: std,
                class: cls,
                type: type,
                staffName: staffName,
                teacher: currentUser.name,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                createdAt: new Date().toISOString()
            };
            
            if (type === 'Negative') {
                const grade = document.getElementById('nGrade').value;
                const issue = document.getElementById('nIssue').value;
                const action = document.getElementById('nAction').value;
                
                if (!grade || !issue || !action) {
                    showAlert('Please fill all required fields', 'error');
                    return;
                }
                
                logEntry.grade = grade;
                logEntry.issue = issue;
                logEntry.action = action;
                logEntry.remarks = document.getElementById('nRemarks').value;
                
                if (localCache.config.features.parentNotifications) {
                    logEntry.notify = document.getElementById('nNotify').value;
                }
            } else {
                const points = document.getElementById('pGrade').value;
                const appreciation = document.getElementById('pAppreciate').value;
                
                if (!appreciation) {
                    showAlert('Please provide appreciation details', 'error');
                    return;
                }
                
                logEntry.grade = points;
                logEntry.appreciation = appreciation;
                
                if (localCache.config.features.parentNotifications) {
                    logEntry.notify = document.getElementById('pNotify').value;
                }
            }
            
            // Save to Firebase
            await database.ref('logs/' + recordId).set(logEntry);
            
            showAlert(`${type} record saved successfully! Syncing to all devices...`, 'success');
            
            // Reset form
            document.getElementById(pre === 'n' ? 'negForm' : 'posForm').reset();
            document.getElementById(pre + 'Std').innerHTML = '<option value="">-- Select Student --</option>';
            if (pre === 'n') {
                document.getElementById('nIssue').innerHTML = '<option value="">-- Select Issue --</option>';
            }
            
            // Re-set today's date and staff name
            const today = new Date().toISOString().split('T')[0];
            document.getElementById(pre + 'Date').value = today;
            document.getElementById(pre + 'StaffName').value = currentUser.name;
            
            setTimeout(() => showMenu(), 1500);
            
        } catch (error) {
            console.error('Save error:', error);
            showAlert('Failed to save record. Please check your connection.', 'error');
        }
    }

    // =====================================================
    // REGISTER TEACHER
    // =====================================================
    async function regT() {
        try {
            const name = document.getElementById('rtName').value.trim();
            const role = document.getElementById('rtRole').value;
            const id = document.getElementById('rtID').value.trim();
            const pass = document.getElementById('rtPass').value.trim();
            
            if (!name || !role || !id || !pass) {
                showAlert('Please fill all fields', 'error');
                return;
            }
            
            if (pass.length < 6) {
                showAlert('Password must be at least 6 characters', 'error');
                return;
            }
            
            // Check if ID already exists
            const snapshot = await database.ref('teachers/' + id).once('value');
            if (snapshot.exists()) {
                showAlert('User ID already exists!', 'error');
                return;
            }
            
            const teacher = {
                name: name,
                role: role,
                id: id,
                pass: pass,
                createdAt: new Date().toISOString()
            };
            
            await database.ref('teachers/' + id).set(teacher);
            
            showAlert('Teacher registered successfully!', 'success');
            document.getElementById('teacherForm').reset();
            setTimeout(() => showMenu(), 1500);
            
        } catch (error) {
            console.error('Registration error:', error);
            showAlert('Failed to register teacher. Please try again.', 'error');
        }
    }

    // =====================================================
    // REGISTER STUDENT
    // =====================================================
    async function regS() {
        try {
            const name = document.getElementById('rsName').value.trim();
            const cls = document.getElementById('rsCls').value;
            const parent = document.getElementById('rsParent').value.trim();
            const contact = document.getElementById('rsContact').value.trim();
            
            if (!name || !cls) {
                showAlert('Please fill required fields', 'error');
                return;
            }
            
            const studentId = 'STD-' + Date.now();
            const student = {
                id: studentId,
                name: name,
                cls: cls,
                parent: parent,
                contact: contact,
                enrolledAt: new Date().toISOString()
            };
            
            await database.ref('students/' + studentId).set(student);
            
            showAlert('Student enrolled successfully!', 'success');
            document.getElementById('studentForm').reset();
            setTimeout(() => showMenu(), 1500);
            
        } catch (error) {
            console.error('Enrollment error:', error);
            showAlert('Failed to enroll student. Please try again.', 'error');
        }
    }

    // =====================================================
    // CHANGE PASSWORD
    // =====================================================
    async function changePassword() {
        try {
            const newPass = document.getElementById('newPassword').value.trim();
            const confirmPass = document.getElementById('confirmPassword').value.trim();
            
            if (!newPass || !confirmPass) {
                showAlert('Please fill in both password fields', 'error');
                return;
            }
            
            if (newPass.length < 6) {
                showAlert('Password must be at least 6 characters', 'error');
                return;
            }
            
            if (newPass !== confirmPass) {
                showAlert('Passwords do not match!', 'error');
                return;
            }
            
            // Update password in Firebase
            if (currentUser.role === 'Admin' || currentUser.role === 'Principal' || currentUser.role === 'Director') {
                await database.ref('admins/' + currentUser.id + '/pass').set(newPass);
            } else {
                await database.ref('teachers/' + currentUser.id + '/pass').set(newPass);
            }
            
            showAlert('Password updated successfully!', 'success');
            document.getElementById('securityForm').reset();
            
            setTimeout(() => {
                alert('Password changed successfully! You will be logged out for security.');
                doLogout();
            }, 1500);
            
        } catch (error) {
            console.error('Password change error:', error);
            showAlert('Failed to change password. Please try again.', 'error');
        }
    }

    // =====================================================
    // FILTER STUDENTS BY CLASS
    // =====================================================
    function filterStudents(pre) {
        const cls = document.getElementById(pre + 'Cls').value;
        const stdSelect = document.getElementById(pre + 'Std');
        
        if (!cls) {
            stdSelect.innerHTML = '<option value="">-- Select Student --</option>';
            return;
        }
        
        const filtered = localCache.students.filter(s => s.cls === cls);
        
        if (filtered.length === 0) {
            stdSelect.innerHTML = '<option value="">No students in this class</option>';
            return;
        }
        
        stdSelect.innerHTML = '<option value="">-- Select Student --</option>' +
            filtered.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
    }

    function updateStudentDropdowns() {
        // Update any currently selected class
        if (document.getElementById('nCls').value) {
            filterStudents('n');
        }
        if (document.getElementById('pCls').value) {
            filterStudents('p');
        }
    }

    // =====================================================
    // NAVIGATION
    // =====================================================
    function showMenu() {
        document.getElementById('main-menu').style.display = 'grid';
        document.querySelectorAll('.container').forEach(c => c.style.display = 'none');
    }

    function showPanel(id) {
        document.getElementById('main-menu').style.display = 'none';
        document.querySelectorAll('.container').forEach(c => c.style.display = 'none');
        document.getElementById(id).style.display = 'block';
        
        if (id === 'tab-ana') {
            loadAnalytics();
        } else if (id === 'tab-manage') {
            loadManageStats();
        } else if (id === 'tab-security') {
            loadSecuritySettings();
        }
    }

    // =====================================================
    // ANALYTICS
    // =====================================================
    function loadAnalytics() {
        const students = localCache.students.map(s => 
            `<option value="${s.name}">${s.name} (${s.cls})</option>`
        ).join('');
        document.getElementById('anaStd').innerHTML = '<option value="">-- Select Student --</option>' + students;
        
        const totalNeg = localCache.logs.filter(l => l.type === 'Negative').length;
        const totalPos = localCache.logs.filter(l => l.type === 'Positive').length;
        
        document.getElementById('overallStats').innerHTML = `
            <div class="stat-card" style="background: var(--neg);">
                <h3>${totalNeg}</h3>
                <p>Total Negative</p>
            </div>
            <div class="stat-card" style="background: var(--pos);">
                <h3>${totalPos}</h3>
                <p>Total Positive</p>
            </div>
            <div class="stat-card">
                <h3>${totalNeg + totalPos}</h3>
                <p>Total Records</p>
            </div>
        `;
        
        loadStats();
    }

    function toggleAnalyticsView() {
        const scope = document.getElementById('repScope').value;
        document.getElementById('searchBox').style.display = scope === 'single' ? 'block' : 'none';
        document.getElementById('classBox').style.display = scope === 'class' ? 'block' : 'none';
        loadStats();
    }

    function loadStats() {
        const scope = document.getElementById('repScope').value;
        let logs = [];
        
        if (scope === 'single') {
            const student = document.getElementById('anaStd').value;
            if (!student) return;
            logs = localCache.logs.filter(l => l.student === student);
        } else if (scope === 'class') {
            const cls = document.getElementById('anaCls').value;
            if (!cls) return;
            logs = localCache.logs.filter(l => l.class === cls);
        } else {
            logs = localCache.logs;
        }
        
        const negLogs = logs.filter(l => l.type === 'Negative');
        const posLogs = logs.filter(l => l.type === 'Positive');
        
        document.getElementById('negLogs').innerHTML = negLogs.length ? 
            negLogs.map(l => `
                <div class="log-entry">
                    <strong>${l.date}</strong><br>
                    Student: ${l.student}<br>
                    Issue: ${l.issue || 'N/A'}<br>
                    Grade: ${l.grade}<br>
                    Staff: ${l.staffName}<br>
                    Teacher: ${l.teacher}
                </div>
            `).join('') : '<p style="text-align:center; color:#999;">No records found</p>';
        
        document.getElementById('posLogs').innerHTML = posLogs.length ?
            posLogs.map(l => `
                <div class="log-entry">
                    <strong>${l.date}</strong><br>
                    Student: ${l.student}<br>
                    Points: ${l.grade}/5<br>
                    Details: ${l.appreciation}<br>
                    Staff: ${l.staffName}<br>
                    Teacher: ${l.teacher}
                </div>
            `).join('') : '<p style="text-align:center; color:#999;">No records found</p>';
        
        document.getElementById('negTotal').textContent = negLogs.length;
        document.getElementById('posTotal').textContent = posLogs.length;
    }

    // =====================================================
    // STATS UPDATES
    // =====================================================
    function updateTeacherStats() {
        const elem = document.getElementById('totalTeachers');
        if (elem) elem.textContent = localCache.teachers.length;
    }

    function updateStudentStats() {
        const elem = document.getElementById('totalStudents');
        if (elem) elem.textContent = localCache.students.length;
    }

    function updateRecordStats() {
        const elem = document.getElementById('totalRecords');
        if (elem) elem.textContent = localCache.logs.length;
    }

    function loadManageStats() {
        updateTeacherStats();
        updateStudentStats();
        updateRecordStats();
    }

    function loadSecuritySettings() {
        document.getElementById('securityUserName').textContent = currentUser.name;
        document.getElementById('securityUserRole').textContent = currentUser.role || 'Teacher';
        document.getElementById('securityUserID').textContent = currentUser.id;
    }

    // =====================================================
    // DOWNLOAD REPORT
    // =====================================================
    function downloadReport() {
        const format = document.getElementById('ext').value;
        const scope = document.getElementById('repScope').value;
        
        let logs = [];
        let reportTitle = `BMC Report`;
        
        if (scope === 'single') {
            const student = document.getElementById('anaStd').value;
            if (!student) {
                showAlert('Please select a student first!', 'error');
                return;
            }
            logs = localCache.logs.filter(l => l.student === student);
            reportTitle = `BMC Report - ${student}`;
        } else if (scope === 'class') {
            const cls = document.getElementById('anaCls').value;
            if (!cls) {
                showAlert('Please select a class first!', 'error');
                return;
            }
            logs = localCache.logs.filter(l => l.class === cls);
            reportTitle = `BMC Report - ${cls}`;
        } else {
            logs = localCache.logs;
        }
        
        if (logs.length === 0) {
            showAlert('No records found to download!', 'error');
            return;
        }
        
        const headers = ['Date', 'Student', 'Class', 'Type', 'Grade', 'Details', 'Staff Name', 'Teacher'];
        const rows = logs.map(log => [
            log.date,
            log.student,
            log.class,
            log.type,
            log.grade,
            log.type === 'Negative' ? (log.issue || 'N/A') : (log.appreciation || 'N/A'),
            log.staffName || log.teacher,
            log.teacher
        ]);
        
        let csvContent = headers.join(',') + '\n';
        rows.forEach(row => {
            csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
        });
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${reportTitle}_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        
        showAlert(`${format.toUpperCase()} report downloaded successfully!`, 'success');
    }

    // =====================================================
    // ALERT SYSTEM
    // =====================================================
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        
        const container = document.querySelector('.container[style*="display: block"]');
        if (container) {
            const panel = container.querySelector('.panel');
            if (panel) {
                panel.insertBefore(alertDiv, panel.firstChild);
                setTimeout(() => alertDiv.remove(), 3000);
            }
        }
    }

    // =====================================================
    // EVENT LISTENERS
    // =====================================================
    document.addEventListener('DOMContentLoaded', function() {
        // Enter key login
        const loginInputs = document.querySelectorAll('#login-section input');
        loginInputs.forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    doLogin();
                }
            });
        });
    });
</script>

</body>
</html>

  <script>
    
  </script>
</body>
</html>
